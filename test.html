<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toolivo Image Resizer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
    :root {
        --primary-blue: #2563eb;
        --primary-blue-light: #3b82f6;
        --primary-blue-dark: #1d4ed8;
        --blue-600: #2563eb;
        --blue-700: #1d4ed8;
        --blue-800: #1e40af;
        --gradient-blue: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        --gradient-blue-reverse: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --info: #3b82f6;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --radius-sm: 0.25rem;
        --radius: 0.5rem;
        --radius-md: 0.75rem;
        --radius-lg: 1rem;
        --radius-xl: 1.5rem;
        
        /* New theme colors from the provided design */
        --primary: #2563eb;
        --primary-dark: #1e40af;
        --primary-light: #3b82f6;
        --secondary: #10b981;
        --secondary-dark: #059669;
        --background: #f8fafc;
        --surface: #ffffff;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border: #e2e8f0;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    body {
        background-color: white;
        color: var(--gray-800);
        line-height: 1.5;
        min-height: 100vh;
        padding: 1rem;
        background: #f0f5ff;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .header {
        text-align: center;
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, #2563eb, #1e40af);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        color: white;
        position: relative;
        overflow: hidden;
    }

    .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
    }

    .header h1 {
        color: white;
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .header p {
        color: rgba(255,255,255,0.9);
        font-size: 1rem;
        max-width: 800px;
        margin: 0 auto;
    }

    .badge {
        background: rgba(255,255,255,0.2);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
        vertical-align: middle;
        backdrop-filter: blur(10px);
    }

    .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    @media (max-width: 1024px) {
        .main-content {
            grid-template-columns: 1fr;
        }
    }

    .card {
        background-color: white;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        height: 100%;
        border: none;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
    }

    .card-header {
        padding: 1.25rem;
        background: linear-gradient(135deg, #2563eb, #1e40af);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-header h2 {
        color: white;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 600;
    }

    .card-content {
        padding: 1.5rem;
    }

    /* UPDATED: New Upload Area */
    .upload-area {
        border: 2px dashed var(--blue-600);
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        background: rgba(37, 99, 235, 0.05);
        transition: all 0.3s ease;
        cursor: pointer;
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        outline: none;
        border-style: dashed !important;
        min-height: 150px;
    }

    .upload-area:hover {
        border-color: var(--blue-600);
        background: rgba(37, 99, 235, 0.1);
        transform: translateY(-2px);
        border-style: dashed !important;
    }

    .upload-icon {
        font-size: 2rem;
        margin-bottom: 0.75rem;
        color: var(--blue-600);
        background: rgba(37, 99, 235, 0.1);
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: auto;
        margin-right: auto;
    }

    .upload-area h3 {
        margin-bottom: 0.25rem;
        color: var(--gray-800);
        font-size: 1rem;
        font-weight: 600;
    }

    .upload-area p {
        color: var(--gray-600);
        margin-bottom: 1rem;
        font-size: 0.85rem;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        font-size: 0.875rem;
        position: relative;
        overflow: hidden;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.5s ease;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn-primary {
        background: linear-gradient(135deg, #2563eb, #1e40af);
        color: white;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #1e40af, #2563eb);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .btn-secondary {
        background-color: var(--gray-200);
        color: var(--gray-800);
    }

    .btn-secondary:hover {
        background-color: var(--gray-300);
        transform: translateY(-2px);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--success) 0%, #0da271 100%);
        color: white;
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #0da271 0%, var(--success) 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-danger {
        background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
        color: white;
    }

    .btn-danger:hover {
        background: linear-gradient(135deg, #dc2626 0%, var(--error) 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .btn-small {
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
    }

    /* UPDATED: Enhanced File Controls */
    .file-controls {
        display: flex;
        justify-content: space-between;
        margin-top: 1rem;
        padding: 0.75rem;
        background: rgba(37, 99, 235, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(37, 99, 235, 0.1);
    }

    .file-controls-group {
        display: flex;
        gap: 0.5rem;
    }

    /* UPDATED: Enhanced File List */
    .file-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        background: white;
        margin-top: 1rem;
    }

    .file-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-bottom: 1px solid var(--gray-100);
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .file-item.selected {
        background: rgba(37, 99, 235, 0.08);
        border-left: 3px solid var(--blue-600);
    }

    .file-item:last-child {
        border-bottom: none;
    }

    .file-item:hover {
        background-color: rgba(37, 99, 235, 0.05);
    }

    .file-checkbox {
        width: 18px;
        height: 18px;
        margin-right: 0.75rem;
        border: 2px solid var(--gray-300);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .file-item.selected .file-checkbox {
        background: var(--blue-600);
        border-color: var(--blue-600);
    }

    .file-checkbox i {
        color: white;
        font-size: 0.7rem;
        opacity: 0;
    }

    .file-item.selected .file-checkbox i {
        opacity: 1;
    }

    .file-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #2563eb, #1e40af);
        border-radius: 6px;
        margin-right: 0.75rem;
        color: white;
        font-size: 0.9rem;
        flex-shrink: 0;
    }

    .file-info {
        flex: 1;
        overflow: hidden;
        min-width: 0;
    }

    .file-name {
        font-weight: 600;
        color: var(--gray-800);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.85rem;
    }

    .file-size {
        font-size: 0.75rem;
        color: var(--gray-600);
    }

    .file-actions {
        flex-shrink: 0;
    }

    /* UPDATED: Cross button for removing files */
    .file-remove-btn {
        background: none;
        border: none;
        color: var(--gray-500);
        cursor: pointer;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .file-remove-btn:hover {
        background-color: var(--error);
        color: white;
        transform: scale(1.1);
    }

    /* RESTORED: Main Tab System for Switching Between Methods */
    .tabs-container-main {
        position: relative;
        margin-bottom: 1.5rem;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .tabs-header-main {
        background: linear-gradient(135deg, #2563eb, #1e40af);
        padding: 20px;
        display: flex;
        gap: 8px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
    }

    .tabs-header-main::-webkit-scrollbar {
        display: none;
    }

    .tab-main {
        flex: 0 0 auto;
        min-width: 90px;
        padding: 12px 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        border-radius: 12px;
        transition: all 0.3s ease;
        gap: 6px;
        text-align: center;
    }

    .tab-main i {
        font-size: 20px;
    }

    .tab-main:hover {
        opacity: 0.9;
    }

    .tab-main.active {
        background: white;
        color: #1e40af;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    /* UPDATED: Smart Compression Specific Styles - Compact Design */
    .tabs-row {
        margin-bottom: 1rem;
    }

    .tabs-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        color: var(--blue-700);
        font-weight: 600;
        font-size: 0.85rem;
    }

    .tabs-label i {
        font-size: 0.9rem;
        color: var(--blue-600);
    }

    .tabs-container-smart {
        position: relative;
        background: linear-gradient(135deg, #2563eb, #1e40af);
        border-radius: 8px;
        padding: 0.5rem;
        overflow: hidden;
        min-height: auto;
    }

    .tabs-scroll {
        display: flex;
        gap: 0.5rem;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
    }

    @media (min-width: 768px) {
        .tabs-scroll {
            justify-content: space-between;
            overflow-x: visible;
        }
        
        .tab-option {
            flex: 1;
            min-width: auto;
            max-width: 140px;
        }
    }

    .tabs-scroll::-webkit-scrollbar {
        display: none;
    }

    .tab-option {
        flex: 0 0 auto;
        min-width: 100px;
        padding: 0.4rem 0.3rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.7rem;
        font-weight: 500;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.3s ease;
        gap: 0.3rem;
        text-align: center;
        white-space: nowrap;
        border: 2px solid transparent;
        min-height: 65px;
    }

    .tab-option i {
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .tab-option:hover {
        color: white;
        background: rgba(255, 255, 255, 0.15);
    }

    .tab-option.active {
        background: white;
        margin-right: 0.3rem;
        margin-left: 0.3rem;
        color: #1e40af;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    .tab-option.active i {
        color: #1e40af;
    }

    .tab-label {
        font-weight: 600;
        font-size: 0.75rem;
        line-height: 1.1;
    }

    .tab-desc {
        font-size: 0.65rem;
        opacity: 0.9;
        line-height: 1;
    }

    /* UPDATED: Smart Compression Specific Styles - Compact Design */
    .slider-container {
        margin: 1.5rem 0;
    }

    .slider-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .slider-label {
        font-weight: 600;
        color: var(--gray-700);
        font-size: 0.9rem;
    }

    .slider-value {
        font-weight: 700;
        font-size: 1rem;
        color: var(--blue-700);
        background: rgba(37, 99, 235, 0.1);
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
    }

    .slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: var(--gray-200);
        outline: none;
        -webkit-appearance: none;
        transition: all 0.3s ease;
    }

    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2563eb, #1e40af);
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        transition: all 0.2s ease;
    }

    .slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 3px 8px rgba(37, 99, 235, 0.3);
    }

    .slider-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: var(--gray-600);
    }

    /* UPDATED: More Settings Dropdown */
    .more-settings {
        margin: 1.5rem 0;
    }

    .settings-toggle {
        width: 100%;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, #2563eb, #1e40af);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.2s ease;
    }

    .settings-toggle:hover {
        background: linear-gradient(135deg, #1e40af, #2563eb);
    }

    .settings-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        background: rgba(37, 99, 235, 0.05);
        border-radius: 0 0 8px 8px;
        border: 1px solid rgba(37, 99, 235, 0.1);
        border-top: none;
    }

    .settings-content.active {
        max-height: 300px;
    }

    .settings-grid {
        padding: 1rem;
        display: grid;
        gap: 0.75rem;
    }

    .setting-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        background: white;
        border-radius: 6px;
        border: 1px solid var(--gray-200);
    }

    .setting-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .setting-icon {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(37, 99, 235, 0.1);
        border-radius: 6px;
        color: var(--blue-600);
        font-size: 0.85rem;
    }

    .setting-text {
        flex: 1;
    }

    .setting-label {
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--gray-800);
        margin-bottom: 0.1rem;
    }

    .setting-desc {
        font-size: 0.75rem;
        color: var(--gray-600);
    }

    /* UPDATED: Quality Indicator */
    .quality-indicator {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        border: 1px solid var(--gray-200);
        margin: 1.5rem 0;
    }

    .quality-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .quality-label {
        font-weight: 600;
        color: var(--gray-700);
        font-size: 0.9rem;
    }

    .quality-value {
        font-weight: 700;
        color: var(--blue-700);
        font-size: 0.9rem;
    }

    .quality-meter {
        height: 8px;
        background: var(--gray-200);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }

    .quality-fill {
        height: 100%;
        background: linear-gradient(90deg, #2563eb, #1e40af);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .quality-text {
        font-size: 0.8rem;
        color: var(--gray-600);
        text-align: center;
        font-weight: 500;
    }

    /* Other Methods Content Styles */
    .method-title {
        font-size: 1.25rem;
        margin-bottom: 1.25rem;
        color: var(--blue-700);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--gray-200);
        font-weight: 600;
    }

    .method-title i {
        color: var(--blue-600);
        background: rgba(37, 99, 235, 0.1);
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .input-group {
        margin-bottom: 1.25rem;
    }

    .input-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--gray-700);
        font-size: 0.875rem;
    }

    .input-row {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .input-with-unit {
        display: flex;
        align-items: center;
        flex: 1;
        position: relative;
    }

    .input-with-unit input {
        flex: 1;
        border: 2px solid var(--gray-300);
        padding: 0.75rem;
        font-size: 0.875rem;
        border-radius: 8px;
        transition: all 0.2s ease;
        background: white;
    }

    .input-with-unit input:focus {
        border-color: var(--blue-600);
        outline: none;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .unit {
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        background: linear-gradient(135deg, #2563eb, #1e40af);
        color: white;
        padding: 0 1rem;
        border-top-right-radius: 8px;
        border-bottom-right-radius: 8px;
        display: flex;
        align-items: center;
        font-weight: 600;
        font-size: 0.875rem;
        pointer-events: none;
    }

    /* DPI Grid */
    .dpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .dpi-preset {
        padding: 0.50rem;
        text-align: center;
        background: white;
        border: 2px solid var(--gray-300);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .dpi-preset:hover {
        border-color: var(--blue-600);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .dpi-preset.active {
        background: linear-gradient(135deg, #2563eb, #1e40af);
        color: white;
        border-color: var(--blue-600);
        box-shadow: 0 6px 16px rgba(37, 99, 235, 0.2);
    }

    .dpi-value {
        font-size: 1.75rem;
        font-weight: 800;
        margin-bottom: 0.25rem;
    }

    .dpi-label {
        font-size: 0.75rem;
        opacity: 0.9;
        font-weight: 600;
    }

    /* NEW: Action Buttons Grid - 3 ROW LAYOUT */
    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 1.5rem;
    }

    /* Row 1: Two buttons side by side - COMPRESS FIRST */
    .top-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        width: 100%;
    }

    .action-btn {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: white;
        border: none;
        padding: 14px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.2s ease;
        width: 100%;
        min-height: 50px;
        position: relative;
        overflow: hidden;
    }

    .action-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.5s ease;
    }

    .action-btn:hover::before {
        left: 100%;
    }

    .action-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
    }

    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .action-btn.secondary {
        background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
    }

    .action-btn.secondary:hover:not(:disabled) {
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
    }

    /* Progress Container */
    .progress-container {
        width: 100%;
        display: none;
        margin-top: 1rem;
    }

    .progress-container.active {
        display: block;
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        align-items: center;
        font-size: 0.875rem;
        color: var(--gray-700);
    }

    .progress-bar {
        height: 10px;
        background-color: var(--gray-200);
        border-radius: 5px;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #2563eb, #1e40af);
        width: 0%;
        transition: width 0.3s ease;
    }

    /* Results Container - FIXED: Hide when new files are added */
    .results-container {
        display: none;
        margin-top: 1.5rem;
        padding: 1rem;
        background: rgba(16, 185, 129, 0.1);
        border-radius: 10px;
        border: 1px solid rgba(16, 185, 129, 0.2);
        transition: all 0.3s ease;
    }

    .results-container.active {
        display: block;
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .results-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        color: var(--success);
        font-weight: 600;
        font-size: 0.95rem;
    }

    .results-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .stat-card {
        background: white;
        padding: 0.75rem;
        border-radius: 8px;
        text-align: center;
    }

    .stat-label {
        font-size: 0.7rem;
        color: var(--gray-600);
        margin-bottom: 0.25rem;
    }

    .stat-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--blue-700);
    }

    .stat-value.success {
        color: var(--success);
    }

    /* Tab content styling */
    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease forwards;
    }

    .tab-content.active {
        display: block;
    }

    /* NEW: Download Dropdown */
    .download-dropdown {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        max-height: 70vh;
        overflow-y: auto;
        width: 90%;
        max-width: 400px;
    }

    .download-dropdown.active {
        display: block;
    }

    .dropdown-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
    }

    .dropdown-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .selection-count {
        font-size: 12px;
        color: var(--primary);
        font-weight: 600;
        background: rgba(37, 99, 235, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
        margin-left: 8px;
    }

    .dropdown-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 18px;
        cursor: pointer;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
    }

    .dropdown-close:hover {
        background: var(--background);
    }

    .dropdown-list {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 16px;
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 6px;
        background: var(--background);
        transition: all 0.2s;
        cursor: pointer;
    }

    .dropdown-item:hover {
        background: #f1f5f9;
    }

    .dropdown-checkbox {
        width: 18px;
        height: 18px;
        border: 2px solid var(--border);
        border-radius: 4px;
        margin-right: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .dropdown-item.selected .dropdown-checkbox {
        background: var(--primary);
        border-color: var(--primary);
    }

    .dropdown-checkbox i {
        color: white;
        font-size: 10px;
        opacity: 0;
    }

    .dropdown-item.selected .dropdown-checkbox i {
        opacity: 1;
    }

    .dropdown-file-info {
        flex: 1;
        min-width: 0;
    }

    .dropdown-file-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .dropdown-file-size {
        font-size: 11px;
        color: var(--text-secondary);
    }

    .dropdown-actions {
        display: flex;
        gap: 8px;
    }

    .dropdown-btn {
        flex: 1;
        padding: 10px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
    }

    .dropdown-confirm {
        background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
        color: white;
    }

    .dropdown-confirm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .dropdown-cancel {
        background: var(--background);
        border: 1px solid var(--border);
        color: var(--text-primary);
    }

    .dropdown-cancel:hover {
        background: #f1f5f9;
    }

    /* NEW: Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        padding: 16px;
    }

    .modal-container {
        background: white;
        border-radius: 16px;
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        background: linear-gradient(135deg, #1e40af, #1e3a8a);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .modal-title {
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .close-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .modal-content {
        padding: 20px;
        flex: 1;
        overflow-y: auto;
    }

    /* Filename Section */
    .filename-section {
        margin-bottom: 20px;
        text-align: center;
    }

    .filename-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .filename-display {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        background: var(--background);
        border-radius: 10px;
        padding: 14px 20px;
        border: 2px solid transparent;
        transition: all 0.2s;
        cursor: text;
        min-height: 52px;
    }

    .filename-display:hover {
        border-color: var(--primary-light);
        background: #f1f5f9;
    }

    .filename-display.editing {
        border-color: var(--primary);
        background: white;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .filename-text {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        flex: 1;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s;
        cursor: pointer;
    }

    .filename-text:hover {
        background: rgba(37, 99, 235, 0.05);
    }

    .filename-input {
        width: 100%;
        padding: 8px 12px;
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        border: 2px solid var(--primary);
        border-radius: 8px;
        background: white;
        text-align: center;
        outline: none;
    }

    .filename-input:focus {
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .edit-hint {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }

    /* Image Comparison */
    .comparison-wrapper {
        position: relative;
        width: 100%;
        height: 300px;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 16px;
        background: var(--background);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .comparison-img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        pointer-events: none;
    }

    .img-after {
        clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%);
    }

    /* Slider Handle */
    .slider-handle {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 4px;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        cursor: ew-resize;
        z-index: 3;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.2);
    }

    .slider-handle::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 24px;
        height: 24px;
        background: white;
        border: 2px solid var(--primary);
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1;
    }

    .slider-handle::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 16px;
        height: 16px;
        background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232563eb' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='15,4 9,12 15,20'/%3E%3Cpolyline points='9,4 15,12 9,20'/%3E%3C/svg%3E") no-repeat center center;
        background-size: contain;
        z-index: 2;
    }

    /* Slider Dividers */
    .slider-divider {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 1px;
        height: 80%;
        background: linear-gradient(
            to bottom,
            transparent 0%,
            rgba(255, 255, 255, 0.8) 20%,
            rgba(255, 255, 255, 0.8) 80%,
            transparent 100%
        );
        z-index: 2;
        pointer-events: none;
    }

    /* Corner Labels */
    .corner-label {
        position: absolute;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        z-index: 2;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .label-original {
        top: 16px;
        left: 16px;
        background: rgba(30, 41, 59, 0.85);
        color: white;
    }

    .label-compressed {
        top: 16px;
        right: 16px;
        background: rgba(16, 185, 129, 0.85);
        color: white;
    }

    /* Navigation */
    .navigation-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
        margin: 20px 0;
        flex-shrink: 0;
    }

    .nav-btn {
        background: var(--background);
        border: 1px solid var(--border);
        color: var(--text-primary);
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .nav-btn:hover:not(:disabled) {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .nav-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .image-counter {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        background: var(--background);
        padding: 6px 16px;
        border-radius: 20px;
        min-width: 70px;
        text-align: center;
        flex-shrink: 0;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin: 20px 0;
    }

    .stat-box {
        background: var(--background);
        padding: 16px;
        border-radius: 10px;
        text-align: center;
        border: 1px solid var(--border);
    }

    .stat-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 4px;
    }

    .stat-value.success {
        color: var(--secondary);
    }

    .stat-label {
        font-size: 11px;
        font-weight: 500;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Download Buttons Grid */
    .download-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        margin-top: 20px;
    }

    .download-btn {
        background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
        color: white;
        border: none;
        padding: 14px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.2s;
    }

    .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
    }

    .download-btn.full {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    }

    .download-btn.full:hover {
        box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
    }

    /* File Details */
    .file-details {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        font-size: 12px;
        margin-top: 20px;
    }

    .detail-item {
        background: var(--background);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
    }

    .detail-label {
        color: var(--text-secondary);
        font-size: 11px;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .detail-value {
        color: var(--text-primary);
        font-weight: 600;
        font-size: 13px;
    }

    /* NEW: Blur effect for settings when no images */
    .blurred-section {
        position: relative;
    }

    .blurred-section::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(4px);
        border-radius: 16px;
        z-index: 10;
        pointer-events: none;
        transition: all 0.3s ease;
    }

    .upload-prompt {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: var(--gray-700);
        font-weight: 600;
        font-size: 1rem;
        z-index: 11;
        display: none;
        background: white;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border: 2px solid var(--blue-600);
        min-width: 250px;
    }

    .blurred-section .upload-prompt {
        display: block;
    }

    .upload-prompt i {
        font-size: 2.5rem;
        color: var(--blue-600);
        margin-bottom: 0.75rem;
        display: block;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .header h1 {
            font-size: 1.5rem;
        }

        .card-header {
            padding: 1rem;
        }

        .card-content {
            padding: 1rem;
        }

        .main-content {
            gap: 1rem;
        }

        .input-row {
            flex-direction: column;
        }

        .input-with-unit {
            width: 100%;
        }

        .tabs-header-main {
            padding: 16px;
            gap: 6px;
        }
        
        .tab-main {
            min-width: 85px;
            padding: 10px 12px;
            font-size: 12px;
        }
        
        .tab-main i {
            font-size: 18px;
        }

        .tabs-container-smart {
            padding: 0.4rem;
        }
        
        .tab-option {
            min-width: 85px;
            padding: 0.35rem 0.25rem;
            font-size: 0.65rem;
        }
        
        .tab-option i {
            font-size: 0.8rem;
        }

        .upload-area {
            min-height: 120px;
            padding: 1rem;
        }
        
        .upload-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            width: 50px;
            height: 50px;
        }
        
        .results-stats {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .comparison-wrapper {
            height: 250px;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .file-details {
            grid-template-columns: 1fr;
        }
        
        .download-grid {
            grid-template-columns: 1fr;
        }
        
        .filename-display {
            flex-direction: column;
            gap: 8px;
        }
        
        .filename-text {
            width: 100%;
        }
        
        /* Mobile adjustments for 3-row button layout */
        .top-row {
            gap: 8px;
        }
        
        .action-btn {
            padding: 12px 8px;
            font-size: 13px;
            min-height: 44px;
        }
        
        .action-btn i {
            font-size: 14px;
        }
    }

    /* Desktop: spread tabs evenly */
    @media (min-width: 768px) {
        .tabs-scroll {
            justify-content: space-between;
            overflow-x: visible;
        }
        
        .tab-option {
            flex: 1;
            min-width: auto;
            max-width: 140px;
        }
        
        .tabs-header-main {
            justify-content: space-between;
        }
        
        .tab-main {
            flex: 1;
            min-width: auto;
        }
        
        .download-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* Utility Classes */
    .hidden {
        display: none !important;
    }

    .text-center {
        text-align: center;
    }

    /* File Count Badge */
    .file-count {
        background: rgba(255,255,255,0.2);
        color: white;
        padding: 0.2rem 0.6rem;
        border-radius: 9999px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    input[type="number"], input[type="text"] {
        padding: 0.75rem;
        border: 2px solid var(--gray-300);
        border-radius: 8px;
        font-size: 0.875rem;
        width: 100%;
        transition: all 0.2s ease;
        background: white;
    }

    input[type="number"]:focus, input[type="text"]:focus {
        outline: none;
        border-color: var(--blue-600);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    select {
        padding: 0.75rem;
        border: 2px solid var(--gray-300);
        border-radius: 8px;
        font-size: 0.875rem;
        width: 100%;
        background: white;
        transition: all 0.2s ease;
    }
    
    select:focus {
        outline: none;
        border-color: var(--blue-600);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    input[type="checkbox"] {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        border: 2px solid var(--gray-300);
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        appearance: none;
        -webkit-appearance: none;
    }
    
    input[type="checkbox"]:checked {
        background: linear-gradient(135deg, #2563eb, #1e40af);
        border-color: var(--blue-600);
    }
    
    input[type="checkbox"]:checked::after {
        content: 'âœ“';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 0.75rem;
        font-weight: bold;
    }
    
    input[type="checkbox"]:hover {
        border-color: var(--blue-600);
    }

    /* Empty State */
    .empty-state {
        padding: 2rem 1rem;
        text-align: center;
        color: var(--gray-500);
    }

    .empty-state i {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
        opacity: 0.3;
    }

    .empty-state p {
        font-size: 0.85rem;
    }
    
    /* File Size Method Styles - FIXED VERSION */
    .file-size-controls {
        margin: 1.5rem 0;
    }

    .file-size-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        color: var(--blue-700);
        font-weight: 600;
        font-size: 0.9rem;
    }

    .file-size-label i {
        color: var(--blue-600);
        font-size: 0.9rem;
    }

    /* Base styles for all size presets */
    .size-presets {
        display: grid;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }

    /* File size method: 6 presets in 3x2 grid on desktop */
    .size-presets:not(.percentage-presets) {
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(2, auto);
    }

    /* Percentage method: 4 presets in 4x1 grid on desktop */
    .percentage-presets {
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: auto;
    }

    .size-preset {
        padding: 0.75rem 0.5rem;
        text-align: center;
        background: white;
        border: 2px solid var(--gray-300);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        min-height: 70px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    /* Make percentage presets slightly taller */
    .percentage-presets .size-preset {
        min-height: 75px;
    }

    .size-preset:hover {
        border-color: var(--blue-600);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .size-preset.active {
        background: linear-gradient(135deg, #2563eb, #1e40af);
        color: white;
        border-color: var(--blue-600);
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.2);
    }

    /* Text color fix - always dark in normal state */
    .size-preset:not(.active) .size-value,
    .size-preset:not(.active) .size-label {
        color: var(--gray-800) !important;
    }

    .size-preset.active .size-value,
    .size-preset.active .size-label {
        color: white !important;
    }

    .size-value {
        font-size: 1rem;
        font-weight: 800;
        margin-bottom: 0.2rem;
    }

    /* Slightly larger text for percentage presets */
    .percentage-presets .size-value {
        font-size: 1.1rem;
    }

    .size-label {
        font-size: 0.7rem;
        opacity: 0.9;
        font-weight: 600;
    }

    .percentage-presets .size-label {
        font-size: 0.75rem;
    }

    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
        /* Both methods: 2 columns on mobile */
        .size-presets {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: auto;
        }
        
        /* Adjust height for mobile */
        .size-preset {
            padding: 0.6rem 0.3rem;
            min-height: 65px;
        }
        
        .percentage-presets .size-preset {
            min-height: 70px;
        }
        
        .size-value {
            font-size: 0.9rem;
        }
        
        .size-label {
            font-size: 0.65rem;
        }
    }

    @media (max-width: 480px) {
        .size-presets {
            gap: 0.3rem;
        }
        
        .size-preset {
            min-height: 60px;
            padding: 0.5rem 0.25rem;
        }
        
        .percentage-presets .size-preset {
            min-height: 65px;
        }
        
        .size-value {
            font-size: 0.85rem;
        }
        
        .size-label {
            font-size: 0.6rem;
        }
    }
    
    /* Size Comparison Layout - MODIFIED: Removed from File Size tab only */
.estimated-size-container {
    margin-top: 2rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, #2563eb, #1e40af);
    border-radius: 12px;
    color: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

.estimated-size-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
}

/* Size Comparison Layout */
.size-comparison {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
}

.size-column {
    flex: 1;
    text-align: center;
    min-width: 0; /* Allow shrinking */
}

.size-label {
    font-weight: 600;
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    flex-wrap: wrap;
}

.size-label i {
    font-size: 0.8rem;
}

.size-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: white;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    background: rgba(255, 255, 255, 0.1);
    padding: 0.35rem;
    border-radius: 6px;
    min-height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    text-overflow: ellipsis;
}

.size-arrow {
    color: white;
    font-size: 1rem;
    opacity: 0.8;
    padding: 0 0.25rem;
    flex-shrink: 0;
}

/* Mobile optimizations */
@media (max-width: 768px) {
    .size-comparison {
        flex-direction: row; /* Keep horizontal */
        gap: 0.5rem;
    }
    
    .size-value {
        font-size: 0.85rem;
        padding: 0.25rem 0.3rem;
        min-height: 1.6rem;
        border-radius: 4px;
    }
    
    .size-arrow {
        font-size: 0.75rem;
        padding: 0 0.15rem;
        transform: none; /* Remove rotation */
    }
    
    .estimated-size-container {
        padding: 1rem 0.75rem;
        margin-top: 1.5rem;
    }
}

/* Extra small screens */
@media (max-width: 480px) {
    .size-comparison {
        gap: 0.25rem;
    }
    
    .size-label {
        font-size: 0.6rem;
    }
    
    .size-label i {
        font-size: 0.6rem;
    }
    
    .size-value {
        font-size: 0.75rem;
        padding: 0.2rem 0.25rem;
        min-height: 1.4rem;
    }
    
    .size-arrow {
        font-size: 0.65rem;
        padding: 0 0.1rem;
    }
}

/* Scrollbar */
.file-list::-webkit-scrollbar,
.modal-content::-webkit-scrollbar,
.dropdown-list::-webkit-scrollbar {
    width: 6px;
}

.file-list::-webkit-scrollbar-track,
.modal-content::-webkit-scrollbar-track,
.dropdown-list::-webkit-scrollbar-track {
    background: var(--background);
    border-radius: 3px;
}

.file-list::-webkit-scrollbar-thumb,
.modal-content::-webkit-scrollbar-thumb,
.dropdown-list::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 3px;
}
</style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-image"></i> Toolivo Image Resizer</h1>
            <p>Resize, compress, and convert multiple images locally in your browser. No data is sent to any server.</p>
        </header>

        <div class="main-content">
            <!-- Left Column: Upload & File Management -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-upload"></i> Upload Images</h2>
                    <span class="file-count">0 files</span>
                </div>
                <div class="card-content">
                    <!-- UPDATED: New Upload Area -->
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h3>Drag & Drop Images</h3>
                        <p>JPG, PNG, GIF, WebP, BMP supported</p>
                        <button class="btn btn-primary" id="browseBtn">
                            <i class="fas fa-folder-open"></i> Browse Files
                        </button>
                        <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
                    </div>

                    <!-- UPDATED: File Controls -->
                    <div class="file-controls">
                        <div class="file-controls-group">
                            <button class="btn btn-primary btn-small" id="selectAllBtn">
                                <i class="fas fa-check"></i> Select All
                            </button>
                            <button class="btn btn-secondary btn-small" id="deselectAllBtn">
                                <i class="fas fa-times"></i> None
                            </button>
                        </div>
                        <button class="btn btn-danger btn-small" id="clearAllBtn">
                            <i class="fas fa-trash-alt"></i> Clear All
                        </button>
                    </div>

                    <!-- UPDATED: File List -->
                    <div class="file-list" id="fileList">
                        <div class="empty-state">
                            <i class="fas fa-images"></i>
                            <p>No images uploaded yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Resize Settings & Preview -->
            <div class="card blurred-section" id="settingsSection">
                <!-- Upload prompt shown when no images -->
                <div class="upload-prompt" id="uploadPrompt">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <div>Upload images to enable settings</div>
                </div>
                
                <div class="card-header">
                    <h2><i class="fas fa-sliders-h"></i> Resizing Methods & Settings</h2>
                </div>
                <div class="card-content" id="settingsContent">
                    <!-- RESTORED: Main Tab System for Switching Between Methods -->
                    <div class="tabs-container-main">
                        <div class="tabs-header-main">
                            <!-- REARRANGED TABS: Quality first, then Smart, File Size, Percentage, DPI -->
                            <div class="tab-main active" data-tab="quality">
                                <i class="fas fa-compress-alt"></i>
                                <span>Quality</span>
                            </div>
                            <div class="tab-main" data-tab="smart-compression">
                                <i class="fas fa-brain"></i>
                                <span>Smart</span>
                            </div>
                            <div class="tab-main" data-tab="file-size">
                                <i class="fas fa-weight-hanging"></i>
                                <span>File Size</span>
                            </div>
                            <div class="tab-main" data-tab="percentage">
                                <i class="fas fa-percentage"></i>
                                <span>Percentage</span>
                            </div>
                            <div class="tab-main" data-tab="dpi">
                                <i class="fas fa-expand"></i>
                                <span>DPI</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quality Tab - MOVED TO FIRST POSITION -->
                    <div class="tab-content active" id="quality-content">
                        <h3 class="method-title"><i class="fas fa-compress-alt"></i> Quality-Based Compression</h3>
                        
                        <!-- 4 COMPACT PRESETS -->
                        <div class="file-size-controls">
                            <div class="file-size-label">
                                <i class="fas fa-bullseye"></i> Quick Quality Presets
                            </div>
                            
                            <div class="size-presets percentage-presets">
                                <div class="size-preset active" data-quality="25">
                                    <div class="size-value">Low</div>
                                    <div class="size-label">Smallest Size</div>
                                </div>
                                <div class="size-preset" data-quality="50">
                                    <div class="size-value">Medium</div>
                                    <div class="size-label">Balanced</div>
                                </div>
                                <div class="size-preset" data-quality="75">
                                    <div class="size-value">High</div>
                                    <div class="size-label">Good Quality</div>
                                </div>
                                <div class="size-preset" data-quality="90">
                                    <div class="size-value">Best</div>
                                    <div class="size-label">Maximum Quality</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quality Slider -->
                        <div class="slider-container">
                            <div class="slider-header">
                                <span class="slider-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-sliders-h"></i> Fine-Tune Quality
                                </span>
                                <span class="slider-value" id="qualityValueTab">50%</span>
                            </div>
                            <input type="range" class="slider" id="qualitySliderTab" min="1" max="100" value="50" step="1">
                            <div class="slider-labels">
                                <span>Lowest (1%)</span>
                                <span>Highest (100%)</span>
                            </div>
                        </div>
                        
                        <!-- Quality Info -->
                        <div class="quality-indicator" style="margin-top: 1.5rem;">
                            <div class="quality-header">
                                <span class="quality-label">Compression Level</span>
                                <span class="quality-value" id="compressionLevelText">Medium</span>
                            </div>
                            <div class="quality-meter">
                                <div class="quality-fill" id="compressionFill"></div>
                            </div>
                            <div class="quality-text" id="compressionDescription">Good balance of quality and file size</div>
                        </div>
                    </div>

                    <!-- Smart Compression Content - MOVED TO SECOND POSITION -->
                    <div class="tab-content" id="smart-compression-content">
                        <!-- Mode Selection (Horizontal Row 1) -->
                        <h3 class="method-title"><i class="fas fa-brain"></i>Smart Compression</h3>
                        <div class="tabs-row">
                            <div class="tabs-label">
                                <i class="fas fa-cog"></i> Compression Mode
                            </div>
                            <div class="tabs-container-smart">
                                <div class="tabs-scroll" id="modeTabs">
                                    <div class="tab-option active" data-mode="perceptual">
                                        <i class="fas fa-eye"></i>
                                        <div class="tab-label">Perceptual</div>
                                        <div class="tab-desc">Balanced</div>
                                    </div>
                                    <div class="tab-option" data-mode="max-compression">
                                        <i class="fas fa-compress-alt"></i>
                                        <div class="tab-label">Max Compress</div>
                                        <div class="tab-desc">Smallest files</div>
                                    </div>
                                    <div class="tab-option" data-mode="lossless">
                                        <i class="fas fa-gem"></i>
                                        <div class="tab-label">Lossless</div>
                                        <div class="tab-desc">Perfect quality</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Usage Selection (Horizontal Row 2) -->
                        <div class="tabs-row">
                            <div class="tabs-label">
                                <i class="fas fa-bullseye"></i> Target Usage
                            </div>
                            <div class="tabs-container-smart">
                                <div class="tabs-scroll" id="usageTabs">
                                    <div class="tab-option active" data-usage="web">
                                        <i class="fas fa-globe"></i>
                                        <div class="tab-label">Web</div>
                                        <div class="tab-desc">Fast loading</div>
                                    </div>
                                    <div class="tab-option" data-usage="social">
                                        <i class="fas fa-share-alt"></i>
                                        <div class="tab-label">Social Media</div>
                                        <div class="tab-desc">Optimized</div>
                                    </div>
                                    <div class="tab-option" data-usage="print">
                                        <i class="fas fa-print"></i>
                                        <div class="tab-label">Print/PDF</div>
                                        <div class="tab-desc">High quality</div>
                                    </div>
                                    <div class="tab-option" data-usage="email">
                                        <i class="fas fa-envelope"></i>
                                        <div class="tab-label">Email</div>
                                        <div class="tab-desc">Small files</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quality vs Size Slider -->
                        <div class="slider-container">
                            <div class="slider-header">
                                <span class="slider-label">Quality vs Size</span>
                                <span class="slider-value" id="smartBalanceValue">Balanced</span>
                            </div>
                            <input type="range" class="slider" id="smartBalanceSlider" min="1" max="100" value="50">
                            <div class="slider-labels">
                                <span>Smaller Size</span>
                                <span>Better Quality</span>
                            </div>
                        </div>

                        <!-- More Settings Dropdown -->
                        <div class="more-settings">
                            <button class="settings-toggle" id="settingsToggle">
                                <span><i class="fas fa-cog"></i> More Settings</span>
                                <i class="fas fa-chevron-down" id="settingsIcon"></i>
                            </button>
                            <div class="settings-content" id="settingsContent">
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <div class="setting-icon">
                                                <i class="fas fa-user-circle"></i>
                                            </div>
                                            <div class="setting-text">
                                                <div class="setting-label">Face Protection</div>
                                                <div class="setting-desc">Preserve facial details</div>
                                            </div>
                                        </div>
                                        <input type="checkbox" id="faceDetection" checked>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <div class="setting-icon">
                                                <i class="fas fa-font"></i>
                                            </div>
                                            <div class="setting-text">
                                                <div class="setting-label">Text Clarity</div>
                                                <div class="setting-desc">Keep text readable</div>
                                            </div>
                                        </div>
                                        <input type="checkbox" id="textProtection" checked>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <div class="setting-info">
                                            <div class="setting-icon">
                                                <i class="fas fa-info-circle"></i>
                                            </div>
                                            <div class="setting-text">
                                                <div class="setting-label">Remove Metadata</div>
                                                <div class="setting-desc">EXIF, GPS, camera data</div>
                                            </div>
                                        </div>
                                        <input type="checkbox" id="metadataRemoval" checked>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quality Indicator -->
                        <div class="quality-indicator">
                            <div class="quality-header">
                                <span class="quality-label">Expected Quality</span>
                                <span class="quality-value" id="smartQualityText">Excellent</span>
                            </div>
                            <div class="quality-meter">
                                <div class="quality-fill" id="smartQualityFill"></div>
                            </div>
                            <div class="quality-text" id="qualityDescription">Optimized for your selected settings</div>
                        </div>
                    </div>

                    <!-- File Size Method - MOVED TO THIRD POSITION -->
                    <div class="tab-content" id="file-size-content">
                        <h3 class="method-title"><i class="fas fa-weight-hanging"></i> Target File Size</h3>
                        
                        <!-- Size Presets - 6 PRESETS -->
                        <div class="file-size-controls">
                            <div class="file-size-label">
                                <i class="fas fa-bullseye"></i> Target File Size Presets
                            </div>
                            
                            <div class="size-presets">
                                <div class="size-preset active" data-size="100">
                                    <div class="size-value">100 KB</div>
                                    <div class="size-label">Web Thumbnail</div>
                                </div>
                                <div class="size-preset" data-size="250">
                                    <div class="size-value">250 KB</div>
                                    <div class="size-label">Small Web</div>
                                </div>
                                <div class="size-preset" data-size="500">
                                    <div class="size-value">500 KB</div>
                                    <div class="size-label">Web Standard</div>
                                </div>
                                <div class="size-preset" data-size="1000">
                                    <div class="size-value">1 MB</div>
                                    <div class="size-label">Hi-res</div>
                                </div>
                                <div class="size-preset" data-size="2000">
                                    <div class="size-value">2 MB</div>
                                    <div class="size-label">Photography</div>
                                </div>
                                <div class="size-preset" data-size="3000">
                                    <div class="size-value">3 MB</div>
                                    <div class="size-label">Print Ready</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slider -->
                        <div class="slider-container">
                            <div class="slider-header">
                                <span class="slider-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-sliders-h"></i> Fine-Tune Target Size
                                </span>
                                <span class="slider-value" id="fileSizeValue">500 KB</span>
                            </div>
                            <input type="range" class="slider" id="fileSizeSlider" min="5" max="5000" value="500" step="5">
                            <div class="slider-labels">
                                <span>5 KB</span>
                                <span id="maxSizeLabel">Max File Size</span>
                            </div>
                        </div>
                    </div>

                    <!-- Percentage Method - MOVED TO FOURTH POSITION -->
                    <div class="tab-content" id="percentage-content">
                        <h3 class="method-title"><i class="fas fa-percentage"></i> Scale by Percentage</h3>
                        
                        <!-- 4 COMPACT PRESETS -->
                        <div class="file-size-controls">
                            <div class="file-size-label">
                                <i class="fas fa-bullseye"></i> Quick Percentage Presets
                            </div>
                            
                            <div class="size-presets percentage-presets">
                                <div class="size-preset active" data-percentage="25">
                                    <div class="size-value">25%</div>
                                    <div class="size-label">Thumbnail</div>
                                </div>
                                <div class="size-preset" data-percentage="50">
                                    <div class="size-value">50%</div>
                                    <div class="size-label">Half Size</div>
                                </div>
                                <div class="size-preset" data-percentage="75">
                                    <div class="size-value">75%</div>
                                    <div class="size-label">Slightly Smaller</div>
                                </div>
                                <div class="size-preset" data-percentage="100">
                                    <div class="size-value">100%</div>
                                    <div class="size-label">Original</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slider -->
                        <div class="slider-container">
                            <div class="slider-header">
                                <span class="slider-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-sliders-h"></i> Fine-Tune Percentage
                                </span>
                                <span class="slider-value" id="percentageValue">25%</span>
                            </div>
                            <input type="range" class="slider" id="percentageSlider" min="1" max="100" value="25" step="1">
                            <div class="slider-labels">
                                <span>1%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>

                    <!-- DPI Method - MOVED TO FIFTH POSITION -->
                    <div class="tab-content" id="dpi-content">
                        <h3 class="method-title"><i class="fas fa-expand"></i> Resize with DPI</h3>
                        
                        <div class="input-group">
                            <label class="input-label">Target DPI (Dots Per Inch)</label>
                            <div class="dpi-grid">
                                <div class="dpi-preset active" data-dpi="72">
                                    <div class="dpi-value">72</div>
                                    <div class="dpi-label">Web Standard</div>
                                </div>
                                <div class="dpi-preset" data-dpi="150">
                                    <div class="dpi-value">150</div>
                                    <div class="dpi-label">Good Print</div>
                                </div>
                                <div class="dpi-preset" data-dpi="300">
                                    <div class="dpi-value">300</div>
                                    <div class="dpi-label">High Quality</div>
                                </div>
                                <div class="dpi-preset" data-dpi="600">
                                    <div class="dpi-value">600</div>
                                    <div class="dpi-label">Professional</div>
                                </div>
                            </div>
                            <div class="slider-container">
                                <div class="slider-header">
                                    <span class="slider-label">DPI Value</span>
                                    <span class="slider-value" id="dpiValue">150</span>
                                </div>
                                <input type="range" class="slider" id="dpiSlider" min="72" max="600" value="150" step="1">
                                <div class="slider-labels">
                                    <span>72 DPI</span>
                                    <span>600 DPI</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NEW: Action Buttons - 3 ROW LAYOUT -->
                    <div class="action-buttons" id="actionButtons">
                        <!-- Row 1: Compress + Preview (side by side) -->
                        <div class="top-row">
                            <button class="action-btn secondary" id="compressBtn" disabled>
                                <i class="fas fa-compress-alt"></i> Compress
                            </button>
                            
                            <button class="action-btn secondary" id="previewBtn" disabled>
                                <i class="fas fa-eye"></i> Preview Selected
                            </button>
                        </div>
                        
                        <!-- Row 2: Download Selected (full width) -->
                        <button class="action-btn" id="downloadSelectedBtn" disabled>
                            <i class="fas fa-download"></i> Download Selected Images (ZIP)
                        </button>
                        
                        <!-- Row 3: Download All (full width) -->
                        <button class="action-btn" id="downloadAllBtn" disabled>
                            <i class="fas fa-file-archive"></i> Download All Images (ZIP)
                        </button>
                    </div>
                    
                    <!-- Progress Container (Hidden by default) -->
                    <div class="progress-container" id="progressContainer">
                        <div class="progress-header">
                            <span style="color: var(--blue-700); font-weight: 600;">Processing...</span>
                            <span id="progressText" style="color: var(--blue-600); font-weight: 600;">0% (0/0)</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>

                    <!-- Results Container - FIXED: Will hide when new files are added -->
                    <div class="results-container" id="resultsContainer">
                        <div class="results-header">
                            <i class="fas fa-check-circle"></i>
                            <span>Processing Complete!</span>
                        </div>
                        <div class="results-stats">
                            <div class="stat-card">
                                <div class="stat-label">Processed</div>
                                <div class="stat-value" id="processedCount">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Size Saved</div>
                                <div class="stat-value success" id="totalSavings">0%</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Quality</div>
                                <div class="stat-value" id="averageQuality">Excellent</div>
                            </div>
                        </div>
                        <p style="font-size: 0.85rem; color: var(--gray-600); line-height: 1.4;">
                            Images optimized successfully. Ready for use.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Download Dropdown -->
    <div class="download-dropdown" id="downloadDropdown">
        <div class="dropdown-header">
            <div class="dropdown-title">
                Select Images to Download
                <span class="selection-count" id="selectionCount">0 selected</span>
            </div>
            <button class="dropdown-close" id="dropdownCloseBtn">&times;</button>
        </div>
        <div class="dropdown-list" id="dropdownList">
            <!-- Dynamic dropdown items will be inserted here -->
        </div>
        <div class="dropdown-actions">
            <button class="dropdown-btn dropdown-cancel" id="dropdownCancelBtn">Cancel</button>
            <button class="dropdown-btn dropdown-confirm" id="dropdownConfirmBtn" disabled>Download Selected</button>
        </div>
    </div>

    <!-- NEW: Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exchange-alt"></i>
                    Image Comparison Preview
                </div>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>

            <div class="modal-content" id="modalContent">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Main Application State
        const state = {
            files: [],
            selectedFiles: new Set(),
            dropdownSelected: new Set(),
            currentIndex: 0,
            isDragging: false,
            isEditingFilename: false,
            editingFilename: '',
            resizeMethod: 'quality',
            qualityLevel: 50,
            isProcessing: false,
            processedImages: [],
            smartCompressionSettings: {
                mode: 'perceptual',
                usage: 'web',
                balance: 50,
                faceDetection: true,
                textProtection: true,
                metadataRemoval: true
            },
            targetFileSizeKB: 500,
            targetFileSizeBytes: 500 * 1024,
            previewCache: new Map() // Cache for preview images
        };

        // Cache for performance optimization
        const calculationCache = new Map();
        let updateTimeout = null;
        const DEBOUNCE_DELAY = 200;

        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const browseBtn = document.getElementById('browseBtn');
        const fileList = document.getElementById('fileList');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const fileCountEl = document.querySelector('.file-count');
        
        // Main tabs
        const mainTabs = document.querySelectorAll('.tab-main');
        
        // Smart Compression Elements
        const smartBalanceSlider = document.getElementById('smartBalanceSlider');
        const smartBalanceValue = document.getElementById('smartBalanceValue');
        const smartQualityFill = document.getElementById('smartQualityFill');
        const smartQualityText = document.getElementById('smartQualityText');
        const qualityDescription = document.getElementById('qualityDescription');
        const faceDetection = document.getElementById('faceDetection');
        const textProtection = document.getElementById('textProtection');
        const metadataRemoval = document.getElementById('metadataRemoval');
        const modeTabs = document.getElementById('modeTabs');
        const usageTabs = document.getElementById('usageTabs');
        const settingsToggle = document.getElementById('settingsToggle');
        const settingsContent = document.getElementById('settingsContent');
        const settingsIcon = document.getElementById('settingsIcon');
        
        // Other method elements
        const percentageSlider = document.getElementById('percentageSlider');
        const percentageValue = document.getElementById('percentageValue');
        
        // File Size elements
        const fileSizeSlider = document.getElementById('fileSizeSlider');
        const fileSizeValue = document.getElementById('fileSizeValue');
        const maxSizeLabel = document.getElementById('maxSizeLabel');
        const sizePresets = document.querySelectorAll('.size-preset');
        
        // Quality tab elements
        const qualitySliderTab = document.getElementById('qualitySliderTab');
        const qualityValueTab = document.getElementById('qualityValueTab');
        const compressionLevelText = document.getElementById('compressionLevelText');
        const compressionFill = document.getElementById('compressionFill');
        const compressionDescription = document.getElementById('compressionDescription');
        const qualityPresets = document.querySelectorAll('#quality-content .size-preset');
        
        // DPI elements
        const dpiSlider = document.getElementById('dpiSlider');
        const dpiValue = document.getElementById('dpiValue');
        
        // NEW: Three buttons
        const previewBtn = document.getElementById('previewBtn');
        const compressBtn = document.getElementById('compressBtn');
        const downloadSelectedBtn = document.getElementById('downloadSelectedBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        
        // Progress and results elements
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const resultsContainer = document.getElementById('resultsContainer');
        const processedCount = document.getElementById('processedCount');
        const totalSavings = document.getElementById('totalSavings');
        const averageQuality = document.getElementById('averageQuality');
        
        // NEW: Modal and Dropdown elements
        const modalOverlay = document.getElementById('modalOverlay');
        const closeModal = document.getElementById('closeModal');
        const modalContent = document.getElementById('modalContent');
        const downloadDropdown = document.getElementById('downloadDropdown');
        const dropdownList = document.getElementById('dropdownList');
        const dropdownCloseBtn = document.getElementById('dropdownCloseBtn');
        const dropdownCancelBtn = document.getElementById('dropdownCancelBtn');
        const dropdownConfirmBtn = document.getElementById('dropdownConfirmBtn');
        const selectionCount = document.getElementById('selectionCount');
        
        // NEW: Blur section elements
        const settingsSection = document.getElementById('settingsSection');
        const settingsContentDiv = document.getElementById('settingsContent');
        const uploadPrompt = document.getElementById('uploadPrompt');

        // Utility Functions
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatKB(kb) {
            return kb >= 1000 ? (kb / 1000).toFixed(1) + ' MB' : kb + ' KB';
        }

        function debounce(func, wait) {
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(updateTimeout);
                    func(...args);
                };
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(later, wait);
            };
        }

        // NEW: Auto-scroll to settings section
        function scrollToSettings() {
            if (settingsSection) {
                settingsSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
                
                // Add highlight animation
                settingsSection.style.boxShadow = '0 0 0 3px rgba(37, 99, 235, 0.3)';
                setTimeout(() => {
                    settingsSection.style.boxShadow = '';
                }, 1500);
            }
        }

        // NEW: Update blur state
        function updateBlurState() {
            const hasFiles = state.files.length > 0;
            
            if (settingsSection) {
                if (hasFiles) {
                    settingsSection.classList.remove('blurred-section');
                    if (settingsContentDiv) settingsContentDiv.style.pointerEvents = 'auto';
                    if (uploadPrompt) uploadPrompt.style.display = 'none';
                } else {
                    settingsSection.classList.add('blurred-section');
                    if (settingsContentDiv) settingsContentDiv.style.pointerEvents = 'none';
                    if (uploadPrompt) uploadPrompt.style.display = 'block';
                }
            }
        }

        // FIXED: Hide results container when new files are added
        function hideResultsContainer() {
            resultsContainer.classList.remove('active');
            progressContainer.classList.remove('active');
            document.getElementById('actionButtons').style.display = 'flex';
        }

        // File list rendering
        function renderFileList() {
            if (state.files.length === 0) {
                fileList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-images"></i>
                        <p>No images uploaded yet</p>
                    </div>
                `;
                updateButtonStates();
                updateBlurState();
                return;
            }
            
            fileList.innerHTML = state.files.map((file, index) => `
                <div class="file-item ${state.selectedFiles.has(index) ? 'selected' : ''}" data-index="${index}">
                    <div class="file-checkbox">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="file-icon">
                        <i class="fas fa-image"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatBytes(file.size)}</div>
                    </div>
                    <div class="file-actions">
                        <button class="file-remove-btn" title="Remove file">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            updateFileCount();
            updateButtonStates();
            updateBlurState();
        }

        function updateFileCount() {
            const count = state.files.length;
            const selectedCount = state.selectedFiles.size;
            fileCountEl.textContent = `${count} files`;
        }

        function updateButtonStates() {
            const hasFiles = state.files.length > 0;
            const hasSelected = state.selectedFiles.size > 0;
            
            previewBtn.disabled = !hasSelected;
            compressBtn.disabled = !hasSelected;
            downloadSelectedBtn.disabled = !hasFiles;
            downloadAllBtn.disabled = !hasFiles;
        }

        // FIXED: Added hideResultsContainer when adding new files
        async function addFiles(newFiles) {
            const validFiles = [];
            
            for (const file of newFiles) {
                if (!state.files.some(f => f.name === file.name && f.size === file.size)) {
                    validFiles.push(file);
                }
            }
            
            if (validFiles.length === 0) return;
            
            // Hide results container when adding new files
            hideResultsContainer();
            
            validFiles.forEach(file => state.files.push(file));
            
            for (let i = state.files.length - validFiles.length; i < state.files.length; i++) {
                state.selectedFiles.add(i);
            }
            
            renderFileList();
            updateSmartCompressionDisplay();
            updateFileSizeSliderMax();
            
            calculationCache.clear();
            
            // Auto-scroll to settings section
            if (validFiles.length > 0) {
                setTimeout(scrollToSettings, 300);
            }
            
            console.log(`Added ${validFiles.length} image(s)`);
        }

        // File Management Functions
        function selectAllFiles() {
            state.files.forEach((_, index) => state.selectedFiles.add(index));
            renderFileList();
            console.log('All files selected');
        }

        function deselectAllFiles() {
            state.selectedFiles.clear();
            renderFileList();
            console.log('All files deselected');
        }

        function clearAllFiles() {
            if (state.files.length === 0) return;
            
            // Hide results container when clearing files
            hideResultsContainer();
            
            state.files = [];
            state.selectedFiles.clear();
            state.dropdownSelected.clear();
            state.currentIndex = 0;
            state.isEditingFilename = false;
            state.editingFilename = '';
            state.previewCache.clear();
            calculationCache.clear();
            renderFileList();
            updateFileSizeSliderMax();
            closeDownloadDropdown();
            
            // Update blur state
            updateBlurState();
            
            console.log('All files cleared');
        }

        // File Size Control Functions
        function setTargetFileSize(kb) {
            const displayText = formatKB(kb);
            fileSizeValue.textContent = displayText;
            fileSizeSlider.value = kb;
            
            sizePresets.forEach(p => {
                p.classList.toggle('active', parseInt(p.dataset.size) === kb);
            });
            
            state.targetFileSizeKB = kb;
            state.targetFileSizeBytes = kb * 1024;
            
            calculationCache.clear();
            
            console.log(`Target size set to ${displayText}`);
        }

        function updateFileSizeSliderMax() {
            if (state.files.length === 0) {
                fileSizeSlider.max = 5000;
                maxSizeLabel.textContent = '5 MB';
                return;
            }
            
            const maxKB = Math.ceil(
                Math.max(...state.files.map(f => f.size / 1024))
            );
            
            const sliderMax = Math.min(5000, maxKB);
            fileSizeSlider.max = sliderMax;
            
            maxSizeLabel.textContent = formatKB(sliderMax);
            
            if (state.targetFileSizeKB > sliderMax) {
                setTargetFileSize(sliderMax);
            }
        }

        // Quality Tab Functions
        function updateQualityDisplay() {
            const quality = parseInt(qualitySliderTab.value);
            
            qualityValueTab.textContent = `${quality}%`;
            qualitySliderTab.value = quality;
            
            qualityPresets.forEach(p => {
                p.classList.toggle('active', parseInt(p.dataset.quality) === quality);
            });
            
            compressionFill.style.width = `${quality}%`;
            
            if (quality >= 90) {
                compressionLevelText.textContent = 'Excellent';
                compressionDescription.textContent = 'Maximum quality with minimal compression';
            } else if (quality >= 75) {
                compressionLevelText.textContent = 'High';
                compressionDescription.textContent = 'High quality with light compression';
            } else if (quality >= 50) {
                compressionLevelText.textContent = 'Medium';
                compressionDescription.textContent = 'Good balance of quality and file size';
            } else if (quality >= 25) {
                compressionLevelText.textContent = 'Low';
                compressionDescription.textContent = 'Noticeable compression for smaller files';
            } else {
                compressionLevelText.textContent = 'Very Low';
                compressionDescription.textContent = 'Heavy compression, smallest file sizes';
            }
            
            state.qualityLevel = quality;
            
            calculationCache.clear();
        }

        // Smart Compression Functions
        function updateSmartCompressionDisplay() {
            state.smartCompressionSettings.balance = parseInt(smartBalanceSlider.value);
            
            if (state.smartCompressionSettings.balance < 33) {
                smartBalanceValue.textContent = 'Small Size';
            } else if (state.smartCompressionSettings.balance < 66) {
                smartBalanceValue.textContent = 'Balanced';
            } else {
                smartBalanceValue.textContent = 'High Quality';
            }
            
            let qualityScore = state.smartCompressionSettings.balance / 100;
            if (state.smartCompressionSettings.mode === 'max-compression') qualityScore *= 0.7;
            else if (state.smartCompressionSettings.mode === 'lossless') qualityScore = 1;
            
            const qualityPercent = Math.round(qualityScore * 100);
            smartQualityFill.style.width = qualityPercent + '%';
            smartQualityText.textContent = qualityPercent + '%';
            
            const qualityText = qualityPercent >= 90 ? 'Excellent' : 
                               qualityPercent >= 75 ? 'Very Good' : 
                               qualityPercent >= 60 ? 'Good' : 'Fair';
            qualityDescription.textContent = `${qualityText} - Optimized for ${state.smartCompressionSettings.usage}`;
        }

        // Switch between main tabs
        function switchTab(tabName) {
            mainTabs.forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                if (content.id === `${tabName}-content`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            state.resizeMethod = tabName;
            
            if (tabName === 'quality') {
                updateQualityDisplay();
            }
        }

        // FIXED: Process image for preview - Actually creates compressed version
        async function processImageForPreview(file, index) {
            // Check cache first
            const cacheKey = `${file.name}-${file.size}-${state.qualityLevel}`;
            if (state.previewCache.has(cacheKey)) {
                return state.previewCache.get(cacheKey);
            }
            
            return new Promise((resolve) => {
                const img = new Image();
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Set canvas size based on resize method
                        let width = img.width;
                        let height = img.height;
                        
                        if (state.resizeMethod === 'percentage') {
                            const percentage = parseInt(percentageSlider.value) / 100;
                            width = img.width * percentage;
                            height = img.height * percentage;
                        } else if (state.resizeMethod === 'dpi') {
                            const dpi = parseInt(dpiSlider.value);
                            // Simplified DPI calculation
                            const scale = dpi / 72; // Assuming 72 DPI as base
                            width = img.width * scale;
                            height = img.height * scale;
                        } else if (state.resizeMethod === 'file-size') {
                            // For file size method, we'll use a reasonable scale
                            width = img.width * 0.7;
                            height = img.height * 0.7;
                        } else {
                            // For quality and smart compression
                            width = img.width;
                            height = img.height;
                        }
                        
                        canvas.width = Math.round(width);
                        canvas.height = Math.round(height);
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // Set quality based on method
                        let quality = state.qualityLevel / 100;
                        if (state.resizeMethod === 'smart-compression') {
                            if (state.smartCompressionSettings.mode === 'max-compression') quality *= 0.6;
                            else if (state.smartCompressionSettings.mode === 'lossless') quality = 0.95;
                        }
                        
                        canvas.toBlob((blob) => {
                            const result = {
                                id: index,
                                original: {
                                    name: file.name,
                                    size: file.size,
                                    url: e.target.result,
                                    width: img.width,
                                    height: img.height,
                                    file: file
                                },
                                compressed: {
                                    size: blob.size,
                                    url: URL.createObjectURL(blob),
                                    width: canvas.width,
                                    height: canvas.height,
                                    blob: blob
                                },
                                savings: ((file.size - blob.size) / file.size * 100).toFixed(1),
                                customName: file.name
                            };
                            
                            // Cache the result
                            state.previewCache.set(cacheKey, result);
                            resolve(result);
                        }, 'image/jpeg', quality);
                    };
                };
                reader.readAsDataURL(file);
            });
        }

        // Image Compression Function
        async function compressImage(file, settings) {
            return new Promise((resolve) => {
                const img = new Image();
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        let scale = 1;
                        if (settings.mode === 'max-compression') scale = 0.7;
                        else if (settings.mode === 'perceptual') scale = 0.9;
                        
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        let imageQuality = state.qualityLevel / 100;
                        if (settings.mode === 'max-compression') imageQuality *= 0.6;
                        else if (settings.mode === 'lossless') imageQuality = 0.95;
                        
                        const mimeType = 'image/jpeg';
                        
                        canvas.toBlob((blob) => {
                            resolve({
                                original: file,
                                compressed: blob,
                                savings: ((file.size - blob.size) / file.size * 100).toFixed(1)
                            });
                        }, mimeType, imageQuality);
                    };
                };
                reader.readAsDataURL(file);
            });
        }

        // Quality compression function
        async function compressImageByQuality(file) {
            return new Promise((resolve) => {
                const img = new Image();
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        const quality = state.qualityLevel / 100;
                        const mimeType = 'image/jpeg';
                        
                        canvas.toBlob((blob) => {
                            resolve({
                                original: file,
                                compressed: blob,
                                savings: ((file.size - blob.size) / file.size * 100).toFixed(1)
                            });
                        }, mimeType, quality);
                    };
                };
                reader.readAsDataURL(file);
            });
        }

        // File size resizing algorithm
        async function resizeImageToTargetSize(file, targetBytes) {
            const type = file.type;
            const isPNG = type === 'image/png';
            const isJPG = /jpe?g/.test(type);
            const isWebP = type === 'image/webp';

            const bitmap = await createBitmap(file).catch(() => null);
            if (!bitmap) {
                return { original: file, compressed: file, sizeError: 0, error: true };
            }

            let canvas = makeCanvas(bitmap.width, bitmap.height);
            let ctx = canvas.getContext('2d');
            let width = bitmap.width;
            let height = bitmap.height;

            function draw(w, h) {
                canvas.width = w;
                canvas.height = h;
                ctx.drawImage(bitmap, 0, 0, w, h);
            }

            const TOL = 5;
            const MAX = 12;

            if (isPNG) {
                let minScale = 0.25;
                let maxScale = 1.0;
                let best = null;
                let bestErr = Infinity;

                for (let i = 0; i < MAX; i++) {
                    const scale = (minScale + maxScale) / 2;
                    const w = Math.round(width * scale);
                    const h = Math.round(height * scale);

                    draw(w, h);
                    const blob = await canvasToBlob(canvas, 'image/png');
                    if (!blob) break;

                    const err = Math.abs((blob.size - targetBytes) / targetBytes) * 100;
                    if (err < bestErr) {
                        best = blob;
                        bestErr = err;
                    }
                    if (err <= TOL) {
                        return { original: file, compressed: blob, sizeError: err.toFixed(1) };
                    }
                    if (blob.size > targetBytes) maxScale = scale;
                    else minScale = scale;
                }

                return { original: file, compressed: best, sizeError: bestErr.toFixed(1) };
            }

            let minQ = 0.12, maxQ = 0.95;
            let q = 0.85;

            let best = null;
            let bestErr = Infinity;
            let scale = 1.0;

            for (let i = 0; i < MAX; i++) {
                const w = Math.round(width * scale);
                const h = Math.round(height * scale);

                draw(w, h);

                const outputType = isWebP ? 'image/webp' : 'image/jpeg';
                const blob = await canvasToBlob(canvas, outputType, q);
                if (!blob) break;

                const err = Math.abs((blob.size - targetBytes) / targetBytes) * 100;

                if (err < bestErr) {
                    best = blob;
                    bestErr = err;
                }
                if (err <= TOL) {
                    return { original: file, compressed: blob, sizeError: err.toFixed(1) };
                }

                if (blob.size > targetBytes) {
                    maxQ = q;
                } else {
                    minQ = q;
                }

                const nextQ = (minQ + maxQ) / 2;

                if (Math.abs(nextQ - q) < 0.01) {
                    scale *= 0.9;
                    minQ = 0.12;
                    maxQ = 0.95;
                    q = 0.75;
                    continue;
                }

                q = nextQ;
            }

            return { original: file, compressed: best, sizeError: bestErr.toFixed(1) };
        }

        // Helper functions for resizing
        function makeCanvas(w, h) {
            if (typeof OffscreenCanvas !== 'undefined') {
                return new OffscreenCanvas(w, h);
            }
            const c = document.createElement('canvas');
            c.width = w;
            c.height = h;
            return c;
        }

        async function createBitmap(file) {
            if (window.createImageBitmap) {
                try {
                    return await createImageBitmap(file);
                } catch {}
            }
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();
                reader.onload = () => (img.src = reader.result);
                img.onload = () => resolve(img);
                img.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function canvasToBlob(canvas, type, q) {
            return new Promise(resolve => {
                if (canvas.convertToBlob) {
                    canvas.convertToBlob({ type, quality: q }).then(resolve);
                    return;
                }
                canvas.toBlob(b => resolve(b), type, q);
            });
        }

        // NEW: Compress button functionality
        async function compressSelectedImages() {
            if (state.files.length === 0) {
                alert('Please upload at least one image');
                return;
            }
            
            if (state.selectedFiles.size === 0) {
                alert('Please select at least one image to compress');
                return;
            }
            
            if (state.isProcessing) return;
            
            // Show processing state
            compressBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Compressing...';
            compressBtn.disabled = true;
            
            // Hide buttons, show progress
            document.getElementById('actionButtons').style.display = 'none';
            progressContainer.classList.add('active');
            resultsContainer.classList.remove('active');
            
            state.isProcessing = true;
            
            const filesToProcess = Array.from(state.selectedFiles)
                .map(index => state.files[index]);
            const totalFiles = filesToProcess.length;
            
            state.processedImages = [];
            
            for (let i = 0; i < filesToProcess.length; i++) {
                const file = filesToProcess[i];
                
                if (state.resizeMethod === 'file-size') {
                    const result = await resizeImageToTargetSize(file, state.targetFileSizeBytes);
                    state.processedImages.push({
                        original: file,
                        compressed: result.compressed,
                        savings: ((file.size - result.compressed.size) / file.size * 100).toFixed(1),
                        sizeError: result.sizeError || '0'
                    });
                } else if (state.resizeMethod === 'quality') {
                    const result = await compressImageByQuality(file);
                    state.processedImages.push(result);
                } else {
                    let settings = state.smartCompressionSettings;
                    
                    if (state.resizeMethod !== 'smart-compression') {
                        settings = {
                            mode: 'perceptual',
                            usage: 'web',
                            balance: 50,
                            faceDetection: true,
                            textProtection: true,
                            metadataRemoval: true
                        };
                    }
                    
                    const result = await compressImage(file, settings);
                    state.processedImages.push(result);
                }
                
                updateProgress(i + 1, totalFiles);
            }
            
            setTimeout(() => {
                showResults();
                downloadSelectedProcessedImages();
                
                // Reset compress button
                compressBtn.innerHTML = '<i class="fas fa-compress-alt"></i> Compress';
                compressBtn.disabled = false;
                
                console.log(`Compressed ${totalFiles} selected image(s) successfully`);
            }, 300);
        }

        // Process and download all images
        async function processAndDownloadAll() {
            if (state.files.length === 0) {
                alert('Please upload at least one image');
                return;
            }
            
            if (state.isProcessing) return;
            
            // Hide buttons, show progress
            document.getElementById('actionButtons').style.display = 'none';
            progressContainer.classList.add('active');
            resultsContainer.classList.remove('active');
            
            state.isProcessing = true;
            
            const filesToProcess = state.files; // Process all files
            const totalFiles = filesToProcess.length;
            
            state.processedImages = [];
            
            for (let i = 0; i < filesToProcess.length; i++) {
                const file = filesToProcess[i];
                
                if (state.resizeMethod === 'file-size') {
                    const result = await resizeImageToTargetSize(file, state.targetFileSizeBytes);
                    state.processedImages.push({
                        original: file,
                        compressed: result.compressed,
                        savings: ((file.size - result.compressed.size) / file.size * 100).toFixed(1),
                        sizeError: result.sizeError || '0'
                    });
                } else if (state.resizeMethod === 'quality') {
                    const result = await compressImageByQuality(file);
                    state.processedImages.push(result);
                } else {
                    let settings = state.smartCompressionSettings;
                    
                    if (state.resizeMethod !== 'smart-compression') {
                        settings = {
                            mode: 'perceptual',
                            usage: 'web',
                            balance: 50,
                            faceDetection: true,
                            textProtection: true,
                            metadataRemoval: true
                        };
                    }
                    
                    const result = await compressImage(file, settings);
                    state.processedImages.push(result);
                }
                
                updateProgress(i + 1, totalFiles);
            }
            
            setTimeout(() => {
                showResults();
                downloadAllProcessedImages();
                console.log(`Processed ${totalFiles} image(s) successfully`);
            }, 300);
        }

        // Process and download selected images
        async function processAndDownloadSelected() {
            if (state.files.length === 0) {
                alert('Please upload at least one image');
                return;
            }
            
            if (state.selectedFiles.size === 0) {
                alert('Please select at least one image to process');
                return;
            }
            
            if (state.isProcessing) return;
            
            // Hide buttons, show progress
            document.getElementById('actionButtons').style.display = 'none';
            progressContainer.classList.add('active');
            resultsContainer.classList.remove('active');
            
            state.isProcessing = true;
            
            const filesToProcess = Array.from(state.selectedFiles)
                .map(index => state.files[index]);
            const totalFiles = filesToProcess.length;
            
            state.processedImages = [];
            
            for (let i = 0; i < filesToProcess.length; i++) {
                const file = filesToProcess[i];
                
                if (state.resizeMethod === 'file-size') {
                    const result = await resizeImageToTargetSize(file, state.targetFileSizeBytes);
                    state.processedImages.push({
                        original: file,
                        compressed: result.compressed,
                        savings: ((file.size - result.compressed.size) / file.size * 100).toFixed(1),
                        sizeError: result.sizeError || '0'
                    });
                } else if (state.resizeMethod === 'quality') {
                    const result = await compressImageByQuality(file);
                    state.processedImages.push(result);
                } else {
                    let settings = state.smartCompressionSettings;
                    
                    if (state.resizeMethod !== 'smart-compression') {
                        settings = {
                            mode: 'perceptual',
                            usage: 'web',
                            balance: 50,
                            faceDetection: true,
                            textProtection: true,
                            metadataRemoval: true
                        };
                    }
                    
                    const result = await compressImage(file, settings);
                    state.processedImages.push(result);
                }
                
                updateProgress(i + 1, totalFiles);
            }
            
            setTimeout(() => {
                showResults();
                downloadSelectedProcessedImages();
                console.log(`Processed ${totalFiles} selected image(s) successfully`);
            }, 300);
        }

        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            progressFill.style.width = percent + '%';
            progressText.textContent = `${percent}% (${current}/${total})`;
        }

        function showResults() {
            const totalOriginal = state.processedImages.reduce((sum, img) => sum + img.original.size, 0);
            const totalCompressed = state.processedImages.reduce((sum, img) => sum + img.compressed.size, 0);
            const savingsPercent = ((totalOriginal - totalCompressed) / totalOriginal * 100).toFixed(1);
            
            processedCount.textContent = state.processedImages.length;
            totalSavings.textContent = `${savingsPercent}%`;
            
            if (state.resizeMethod === 'file-size') {
                const avgError = state.processedImages.reduce((sum, img) => 
                    sum + Math.abs(parseFloat(img.sizeError || 0)), 0) / state.processedImages.length;
                averageQuality.textContent = `Â±${avgError.toFixed(1)}%`;
            } else {
                averageQuality.textContent = 'Excellent';
            }
            
            state.isProcessing = false;
            progressContainer.classList.remove('active');
            resultsContainer.classList.add('active');
            
            // Show buttons again after 3 seconds
            setTimeout(() => {
                document.getElementById('actionButtons').style.display = 'flex';
            }, 3000);
        }

        // Download all processed images as ZIP
        async function downloadAllProcessedImages() {
            if (state.processedImages.length === 0) {
                console.error('No processed images available');
                return;
            }
            
            console.log('Creating ZIP file...');
            
            const zip = new JSZip();
            const folder = zip.folder("processed_images");
            
            for (let i = 0; i < state.processedImages.length; i++) {
                const image = state.processedImages[i];
                
                try {
                    const response = await fetch(URL.createObjectURL(image.compressed));
                    const blob = await response.blob();
                    
                    let extension = 'jpeg';
                    let fileName;
                    
                    if (state.resizeMethod === 'file-size') {
                        const nameOnly = image.original.name.replace(/\.[^/.]+$/, "");
                        fileName = `${nameOnly}_${formatKB(state.targetFileSizeKB)}.${extension}`;
                    } else if (state.resizeMethod === 'quality') {
                        const nameOnly = image.original.name.replace(/\.[^/.]+$/, "");
                        fileName = `${nameOnly}_quality${state.qualityLevel}.${extension}`;
                    } else {
                        fileName = `processed_${image.original.name.replace(/\.[^/.]+$/, "")}.${extension}`;
                    }
                    
                    folder.file(fileName, blob);
                } catch (error) {
                    console.error('Error adding image to ZIP:', error);
                }
            }
            
            zip.generateAsync({type: "blob"})
                .then(function(content) {
                    saveAs(content, "processed_images.zip");
                    console.log('ZIP file downloaded successfully');
                })
                .catch(function(error) {
                    console.error('Error creating ZIP:', error);
                });
        }

        // Download selected processed images as ZIP
        async function downloadSelectedProcessedImages() {
            if (state.processedImages.length === 0) {
                console.error('No processed images available');
                return;
            }
            
            console.log('Creating ZIP file for selected images...');
            
            const zip = new JSZip();
            const folder = zip.folder("selected_images");
            
            for (let i = 0; i < state.processedImages.length; i++) {
                const image = state.processedImages[i];
                
                try {
                    const response = await fetch(URL.createObjectURL(image.compressed));
                    const blob = await response.blob();
                    
                    let extension = 'jpeg';
                    let fileName;
                    
                    if (state.resizeMethod === 'file-size') {
                        const nameOnly = image.original.name.replace(/\.[^/.]+$/, "");
                        fileName = `${nameOnly}_${formatKB(state.targetFileSizeKB)}.${extension}`;
                    } else if (state.resizeMethod === 'quality') {
                        const nameOnly = image.original.name.replace(/\.[^/.]+$/, "");
                        fileName = `${nameOnly}_quality${state.qualityLevel}.${extension}`;
                    } else {
                        fileName = `processed_${image.original.name.replace(/\.[^/.]+$/, "")}.${extension}`;
                    }
                    
                    folder.file(fileName, blob);
                } catch (error) {
                    console.error('Error adding image to ZIP:', error);
                }
            }
            
            zip.generateAsync({type: "blob"})
                .then(function(content) {
                    saveAs(content, "selected_images.zip");
                    console.log('ZIP file downloaded successfully');
                })
                .catch(function(error) {
                    console.error('Error creating ZIP:', error);
                });
        }

        // NEW: Download dropdown functionality
        function updateSelectionCount() {
            if (selectionCount) {
                selectionCount.textContent = `${state.dropdownSelected.size} selected`;
            }
        }

        // Render dropdown list
        function renderDropdownList() {
            // Sync dropdown selection from main selection
            state.dropdownSelected = new Set(state.selectedFiles);

            if (state.files.length === 0) {
                dropdownList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <i class="fas fa-images" style="font-size: 32px; margin-bottom: 10px; opacity: 0.3;"></i>
                        <p style="font-size: 13px;">No images uploaded</p>
                    </div>
                `;
                dropdownConfirmBtn.disabled = true;
                updateSelectionCount();
                return;
            }

            let html = '';
            state.files.forEach((file, index) => {
                const isSelected = state.dropdownSelected.has(index);
                html += `
                    <div class="dropdown-item ${isSelected ? 'selected' : ''}" data-index="${index}">
                        <div class="dropdown-checkbox">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="dropdown-file-info">
                            <div class="dropdown-file-name">${file.name}</div>
                            <div class="dropdown-file-size">${formatBytes(file.size)}</div>
                        </div>
                    </div>
                `;
            });
            dropdownList.innerHTML = html;
            dropdownConfirmBtn.disabled = state.dropdownSelected.size === 0;
            updateSelectionCount();
        }

        // Show dropdown
        function showDownloadDropdown() {
            renderDropdownList();
            downloadDropdown.classList.add('active');
            // Close on outside click
            setTimeout(() => {
                const closeHandler = (e) => {
                    if (!downloadDropdown.contains(e.target) && !downloadSelectedBtn.contains(e.target)) {
                        closeDownloadDropdown();
                        document.removeEventListener('click', closeHandler);
                    }
                };
                document.addEventListener('click', closeHandler);
            }, 10);
        }

        // Close dropdown
        function closeDownloadDropdown() {
            downloadDropdown.classList.remove('active');
        }

        // Download selected from dropdown
        async function downloadSelectedFromDropdown() {
            if (!state.dropdownSelected.size) return;

            // Update main selection to match dropdown
            state.selectedFiles = new Set(state.dropdownSelected);
            renderFileList();
            
            // Process and download selected images
            await processAndDownloadSelected();
            closeDownloadDropdown();
        }

        // FIXED: Update preview modal - Actually processes and shows images
        async function updatePreview() {
            if (state.files.length === 0 || state.selectedFiles.size === 0) {
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-images" style="font-size: 40px; margin-bottom: 16px; opacity: 0.3;"></i>
                        <p>No images selected for preview</p>
                    </div>
                `;
                return;
            }

            const currentImageIndex = Array.from(state.selectedFiles)[state.currentIndex];
            const currentFile = state.files[currentImageIndex];
            if (!currentFile) return;

            // Show loading state
            modalContent.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-cog fa-spin" style="font-size: 40px; margin-bottom: 16px;"></i>
                    <p>Processing image preview...</p>
                </div>
            `;

            try {
                // Process the image for preview
                const processedImage = await processImageForPreview(currentFile, currentImageIndex);
                
                const displayName = currentFile.name;
                const fileNameWithoutExt = displayName.replace(/\.[^/.]+$/, '');

                modalContent.innerHTML = `
                    <!-- Direct Editable Filename Section -->
                    <div class="filename-section">
                        <div class="filename-label">
                            <i class="fas fa-file-alt"></i>
                            Image Filename
                        </div>
                        <div class="filename-display ${state.isEditingFilename ? 'editing' : ''}" id="filenameDisplay">
                            ${state.isEditingFilename ? `
                                <input type="text" 
                                       class="filename-input" 
                                       id="filenameInput" 
                                       value="${state.editingFilename || fileNameWithoutExt}"
                                       maxlength="50"
                                       placeholder="Enter filename">
                            ` : `
                                <div class="filename-text" id="filenameText">${displayName}</div>
                            `}
                        </div>
                        <div class="edit-hint" id="editHint">
                            <i class="fas fa-info-circle"></i>
                            ${state.isEditingFilename ? 'Press Enter to save, Esc to cancel' : 'Click on filename to edit'}
                        </div>
                    </div>
                    <div class="comparison-wrapper" id="imageContainer">
                        <span class="corner-label label-original">Original</span>
                        <span class="corner-label label-compressed">Compressed</span>
                        <img src="${processedImage.compressed.url}" class="comparison-img img-before" alt="Compressed" id="compressedImg">
                        <img src="${processedImage.original.url}" class="comparison-img img-after" alt="Original" id="originalImg">
                        <div class="slider-divider"></div>
                        <div class="slider-handle" id="sliderHandle"></div>
                    </div>
                    ${state.selectedFiles.size > 1 ? `
                    <div class="navigation-controls">
                        <button class="nav-btn" id="prevBtn" ${state.currentIndex === 0 ? 'disabled' : ''}>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="image-counter">
                            ${state.currentIndex + 1} / ${state.selectedFiles.size}
                        </div>
                        <button class="nav-btn" id="nextBtn" ${state.currentIndex === state.selectedFiles.size - 1 ? 'disabled' : ''}>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    ` : ''}
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value">${formatBytes(processedImage.original.size)}</div>
                            <div class="stat-label">Original Size</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value success">${formatBytes(processedImage.compressed.size)}</div>
                            <div class="stat-label">Compressed Size</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value success">${processedImage.savings}%</div>
                            <div class="stat-label">Size Reduction</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${processedImage.original.width} Ã— ${processedImage.original.height}</div>
                            <div class="stat-label">Original Dimensions</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${processedImage.compressed.width} Ã— ${processedImage.compressed.height}</div>
                            <div class="stat-label">New Dimensions</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${getMethodDisplayName()}</div>
                            <div class="stat-label">Compression Method</div>
                        </div>
                    </div>
                    <div class="file-details">
                        <div class="detail-item">
                            <div class="detail-label">File Name</div>
                            <div class="detail-value" id="currentFileName">${displayName}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Compression Quality</div>
                            <div class="detail-value">${state.qualityLevel}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Size Saved</div>
                            <div class="detail-value">${processedImage.savings}% (${formatBytes(processedImage.original.size - processedImage.compressed.size)})</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Processing</div>
                            <div class="detail-value">Client-side</div>
                        </div>
                    </div>
                    <div class="download-grid">
                        <button class="download-btn" id="downloadSingleBtn">
                            <i class="fas fa-download"></i> Download This Image
                        </button>
                        <button class="download-btn full" id="downloadAllModalBtn">
                            <i class="fas fa-file-archive"></i> Process & Download All Images (ZIP)
                        </button>
                    </div>
                `;
                
                setupFilenameEditing();
                setupSlider();
                setupNavigation();
                setupDownloadButtons(processedImage);
            } catch (error) {
                console.error('Error processing preview:', error);
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--error);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 40px; margin-bottom: 16px;"></i>
                        <p>Error processing image preview</p>
                        <p style="font-size: 12px; margin-top: 8px;">${error.message}</p>
                    </div>
                `;
            }
        }

        // Helper function to get display name for current compression method
        function getMethodDisplayName() {
            switch(state.resizeMethod) {
                case 'quality':
                    return `Quality: ${state.qualityLevel}%`;
                case 'smart-compression':
                    const mode = state.smartCompressionSettings.mode;
                    if (mode === 'perceptual') return 'Smart (Perceptual)';
                    if (mode === 'max-compression') return 'Smart (Max)';
                    if (mode === 'lossless') return 'Smart (Lossless)';
                    return 'Smart Compression';
                case 'file-size':
                    return `Target Size: ${formatKB(state.targetFileSizeKB)}`;
                case 'percentage':
                    return `Scale: ${percentageSlider.value}%`;
                case 'dpi':
                    return `DPI: ${dpiSlider.value}`;
                default:
                    return 'Custom';
            }
        }

        // Setup filename editing
        function setupFilenameEditing() {
            const filenameText = document.getElementById('filenameText');
            const filenameInput = document.getElementById('filenameInput');
            const filenameDisplay = document.getElementById('filenameDisplay');
            const editHint = document.getElementById('editHint');

            if (filenameText) {
                filenameText.addEventListener('click', startEditing);
            }
            if (filenameDisplay && !state.isEditingFilename) {
                filenameDisplay.addEventListener('click', startEditing);
            }

            if (filenameInput) {
                filenameInput.focus();
                filenameInput.select();
                filenameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        saveFilename();
                    } else if (e.key === 'Escape') {
                        cancelEditing();
                    }
                });
                filenameInput.addEventListener('blur', saveFilename);
            }

            function startEditing(e) {
                const selectedIndices = Array.from(state.selectedFiles);
                if (selectedIndices.length === 0) return;
                
                const currentImageIndex = selectedIndices[state.currentIndex];
                const currentFile = state.files[currentImageIndex];
                if (!currentFile) return;
                
                const displayName = currentFile.name;
                const fileNameWithoutExt = displayName.replace(/\.[^/.]+$/, '');
                state.isEditingFilename = true;
                state.editingFilename = fileNameWithoutExt;
                updatePreview();
            }

            function saveFilename() {
                const filenameInput = document.getElementById('filenameInput');
                if (!filenameInput) return;
                const newName = filenameInput.value.trim();
                
                const selectedIndices = Array.from(state.selectedFiles);
                if (selectedIndices.length === 0) return;
                
                const currentImageIndex = selectedIndices[state.currentIndex];
                const currentFile = state.files[currentImageIndex];
                if (!currentFile) return;
                
                if (newName && newName !== currentFile.name.replace(/\.[^/.]+$/, '')) {
                    const extension = currentFile.name.match(/\.[^/.]+$/)?.[0] || '.jpg';
                    const fullName = newName + extension;
                    currentFile.name = fullName;
                    state.files[currentImageIndex] = currentFile;
                    renderFileList();
                    const filenameDisplay = document.getElementById('filenameDisplay');
                    if (filenameDisplay) {
                        filenameDisplay.style.borderColor = 'var(--secondary)';
                        filenameDisplay.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
                        setTimeout(() => {
                            state.isEditingFilename = false;
                            state.editingFilename = '';
                            updatePreview();
                        }, 500);
                    }
                } else {
                    cancelEditing();
                }
            }

            function cancelEditing() {
                state.isEditingFilename = false;
                state.editingFilename = '';
                updatePreview();
            }
        }

        // Setup slider for image comparison
        function setupSlider() {
            const container = document.getElementById('imageContainer');
            const handle = document.getElementById('sliderHandle');
            const afterImg = container?.querySelector('.img-after');
            const divider = container?.querySelector('.slider-divider');
            if (!container || !handle || !afterImg) return;

            function updateSlider(clientX) {
                const rect = container.getBoundingClientRect();
                let x = ((clientX - rect.left) / rect.width) * 100;
                x = Math.max(0, Math.min(x, 100));
                afterImg.style.clipPath = `polygon(0 0, ${x}% 0, ${x}% 100%, 0 100%)`;
                handle.style.left = `${x}%`;
                if (divider) divider.style.left = `${x}%`;
            }

            handle.addEventListener('mousedown', (e) => {
                state.isDragging = true;
                e.preventDefault();
            });
            document.addEventListener('mousemove', (e) => {
                if (state.isDragging) updateSlider(e.clientX);
            });
            document.addEventListener('mouseup', () => {
                state.isDragging = false;
            });

            handle.addEventListener('touchstart', (e) => {
                state.isDragging = true;
                e.preventDefault();
            });
            document.addEventListener('touchmove', (e) => {
                if (state.isDragging && e.touches[0]) {
                    updateSlider(e.touches[0].clientX);
                }
            });
            document.addEventListener('touchend', () => {
                state.isDragging = false;
            });

            container.addEventListener('click', (e) => {
                updateSlider(e.clientX);
            });
        }

        // Setup navigation
        function setupNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (state.currentIndex > 0) {
                        state.currentIndex--;
                        state.isEditingFilename = false;
                        state.editingFilename = '';
                        updatePreview();
                    }
                });
            }
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (state.currentIndex < state.selectedFiles.size - 1) {
                        state.currentIndex++;
                        state.isEditingFilename = false;
                        state.editingFilename = '';
                        updatePreview();
                    }
                });
            }
        }

        // Setup download buttons in modal
        function setupDownloadButtons(processedImage) {
            const downloadSingleBtn = document.getElementById('downloadSingleBtn');
            if (downloadSingleBtn) {
                downloadSingleBtn.addEventListener('click', () => {
                    // Download this single image
                    const link = document.createElement('a');
                    link.href = processedImage.compressed.url;
                    const displayName = processedImage.original.name;
                    link.download = `compressed_${displayName.replace(/\.[^/.]+$/, '')}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            }

            const downloadAllModalBtn = document.getElementById('downloadAllModalBtn');
            if (downloadAllModalBtn) {
                downloadAllModalBtn.addEventListener('click', () => {
                    // Process and download all images
                    modalOverlay.style.display = 'none';
                    processAndDownloadAll();
                });
            }
        }

        // Setup tab scrolling for mobile
        function setupTabScrolling() {
            if (window.innerWidth > 768) return;

            const mainTabsHeader = document.querySelector('.tabs-header-main');
            const smartTabsHeaders = [modeTabs, usageTabs];
            
            mainTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    setTimeout(() => {
                        const containerRect = mainTabsHeader.getBoundingClientRect();
                        const tabRect = tab.getBoundingClientRect();
                        
                        const containerCenter = containerRect.left + containerRect.width / 2;
                        const tabCenter = tabRect.left + tabRect.width / 2;
                        const scrollOffset = tabCenter - containerCenter;
                        const newScrollLeft = mainTabsHeader.scrollLeft + scrollOffset;

                        mainTabsHeader.scrollTo({
                            left: newScrollLeft,
                            behavior: 'smooth'
                        });
                    }, 100);
                });
            });
            
            smartTabsHeaders.forEach(tabsHeader => {
                tabsHeader.querySelectorAll('.tab-option').forEach(tab => {
                    tab.addEventListener('click', () => {
                        setTimeout(() => {
                            const containerRect = tabsHeader.getBoundingClientRect();
                            const tabRect = tab.getBoundingClientRect();
                            
                            const containerCenter = containerRect.left + containerRect.width / 2;
                            const tabCenter = tabRect.left + tabRect.width / 2;
                            const scrollOffset = tabCenter - containerCenter;
                            const newScrollLeft = tabsHeader.scrollLeft + scrollOffset;

                            tabsHeader.scrollTo({
                                left: newScrollLeft,
                                behavior: 'smooth'
                            });
                        }, 100);
                    });
                });
            });
        }

        // Event Listeners Setup
        function setupEventListeners() {
            browseBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                fileInput.click();
            });
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
                if (files.length > 0) {
                    addFiles(files);
                } else {
                    alert('Please drop image files only');
                }
            });

            fileInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    addFiles(files);
                    this.value = '';
                }
            });

            selectAllBtn.addEventListener('click', selectAllFiles);
            deselectAllBtn.addEventListener('click', deselectAllFiles);
            clearAllBtn.addEventListener('click', clearAllFiles);

            fileList.addEventListener('click', (e) => {
                const fileItem = e.target.closest('.file-item');
                if (!fileItem) return;
                
                const index = parseInt(fileItem.dataset.index);
                
                if (e.target.closest('.file-remove-btn')) {
                    e.stopPropagation();
                    state.files.splice(index, 1);
                    state.selectedFiles.delete(index);
                    
                    const newSelected = new Set();
                    state.selectedFiles.forEach(value => {
                        if (value > index) {
                            newSelected.add(value - 1);
                        } else if (value < index) {
                            newSelected.add(value);
                        }
                    });
                    state.selectedFiles = newSelected;
                    
                    calculationCache.clear();
                    state.previewCache.clear();
                    updateFileSizeSliderMax();
                    
                    // Hide results when files are removed
                    hideResultsContainer();
                    
                    renderFileList();
                    console.log('File removed');
                } else if (e.target.closest('.file-checkbox') || e.target.closest('.file-item:not(.file-actions *)')) {
                    if (state.selectedFiles.has(index)) {
                        state.selectedFiles.delete(index);
                    } else {
                        state.selectedFiles.add(index);
                    }
                    renderFileList();
                }
            });

            // Main tabs switching
            mainTabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Smart settings
            smartBalanceSlider.addEventListener('input', updateSmartCompressionDisplay);
            
            faceDetection.addEventListener('change', () => {
                state.smartCompressionSettings.faceDetection = faceDetection.checked;
                calculationCache.clear();
                state.previewCache.clear();
            });
            
            textProtection.addEventListener('change', () => {
                state.smartCompressionSettings.textProtection = textProtection.checked;
                calculationCache.clear();
                state.previewCache.clear();
            });
            
            metadataRemoval.addEventListener('change', () => {
                state.smartCompressionSettings.metadataRemoval = metadataRemoval.checked;
                calculationCache.clear();
                state.previewCache.clear();
            });

            // Mode tabs
            modeTabs.querySelectorAll('.tab-option').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    modeTabs.querySelectorAll('.tab-option').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    state.smartCompressionSettings.mode = tab.dataset.mode;
                    calculationCache.clear();
                    state.previewCache.clear();
                    updateSmartCompressionDisplay();
                });
            });

            // Usage tabs
            usageTabs.querySelectorAll('.tab-option').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    usageTabs.querySelectorAll('.tab-option').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    state.smartCompressionSettings.usage = tab.dataset.usage;
                    calculationCache.clear();
                    state.previewCache.clear();
                    updateSmartCompressionDisplay();
                });
            });

            // Settings toggle
            settingsToggle.addEventListener('click', () => {
                const isActive = settingsContent.classList.toggle('active');
                settingsIcon.classList.toggle('fa-chevron-down', !isActive);
                settingsIcon.classList.toggle('fa-chevron-up', isActive);
            });

            // File size controls
            sizePresets.forEach(preset => {
                preset.addEventListener('click', () => {
                    const sizeKB = parseInt(preset.dataset.size);
                    setTargetFileSize(sizeKB);
                    state.previewCache.clear();
                });
            });

            fileSizeSlider.addEventListener('input', () => {
                const sizeKB = parseInt(fileSizeSlider.value);
                setTargetFileSize(sizeKB);
                state.previewCache.clear();
            });

            // Percentage controls
            const percentagePresets = document.querySelectorAll('#percentage-content .size-preset');

            function setPercentage(value) {
                value = Math.min(100, Math.max(1, parseInt(value) || 25));
                
                percentageValue.textContent = `${value}%`;
                percentageSlider.value = value;
                
                percentagePresets.forEach(p => {
                    p.classList.toggle('active', parseInt(p.dataset.percentage) === value);
                });
                
                calculationCache.clear();
                state.previewCache.clear();
            }

            percentageSlider.addEventListener('input', () => {
                setPercentage(percentageSlider.value);
            });

            percentagePresets.forEach(preset => {
                preset.addEventListener('click', () => {
                    setPercentage(preset.dataset.percentage);
                });
            });

            // Quality tab controls
            qualitySliderTab.addEventListener('input', updateQualityDisplay);

            qualityPresets.forEach(preset => {
                preset.addEventListener('click', () => {
                    const quality = parseInt(preset.dataset.quality);
                    qualitySliderTab.value = quality;
                    updateQualityDisplay();
                    state.previewCache.clear();
                });
            });

            // DPI controls
            dpiSlider.addEventListener('input', () => {
                dpiValue.textContent = dpiSlider.value;
                calculationCache.clear();
                state.previewCache.clear();
            });
            
            document.querySelectorAll('.dpi-preset').forEach(preset => {
                preset.addEventListener('click', () => {
                    document.querySelectorAll('.dpi-preset').forEach(p => p.classList.remove('active'));
                    preset.classList.add('active');
                    dpiSlider.value = preset.dataset.dpi;
                    dpiValue.textContent = preset.dataset.dpi;
                    calculationCache.clear();
                    state.previewCache.clear();
                });
            });

            // NEW: Four button event listeners
            previewBtn.addEventListener('click', () => {
                if (state.files.length > 0 && state.selectedFiles.size > 0) {
                    const selectedIds = Array.from(state.selectedFiles);
                    state.currentIndex = 0; // Start from first selected
                    state.isEditingFilename = false;
                    state.editingFilename = '';
                    updatePreview();
                    modalOverlay.style.display = 'flex';
                }
            });

            // NEW: Compress button event listener
            compressBtn.addEventListener('click', compressSelectedImages);
            
            downloadSelectedBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showDownloadDropdown();
            });
            
            downloadAllBtn.addEventListener('click', processAndDownloadAll);

            // Dropdown event listeners
            dropdownCloseBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                closeDownloadDropdown();
            });
            
            dropdownCancelBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                closeDownloadDropdown();
            });
            
            dropdownConfirmBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                downloadSelectedFromDropdown();
            });

            // Modal event listeners
            closeModal.addEventListener('click', () => {
                modalOverlay.style.display = 'none';
            });
            
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.style.display = 'none';
                }
            });

            // Dropdown item click handler
            dropdownList.addEventListener('click', (e) => {
                const item = e.target.closest('.dropdown-item');
                if (!item) return;

                const index = parseInt(item.dataset.index);
                const wasSelected = state.dropdownSelected.has(index);
                if (wasSelected) {
                    state.dropdownSelected.delete(index);
                } else {
                    state.dropdownSelected.add(index);
                }

                item.classList.toggle('selected', !wasSelected);
                updateSelectionCount();
                dropdownConfirmBtn.disabled = state.dropdownSelected.size === 0;
            });

            document.addEventListener('keydown', (e) => {
                if (!modalOverlay.style.display || modalOverlay.style.display === 'none') return;
                if (e.key === 'ArrowLeft') {
                    const prevBtn = document.getElementById('prevBtn');
                    if (prevBtn && !prevBtn.disabled) prevBtn.click();
                } else if (e.key === 'ArrowRight') {
                    const nextBtn = document.getElementById('nextBtn');
                    if (nextBtn && !nextBtn.disabled) nextBtn.click();
                } else if (e.key === 'Escape') {
                    if (state.isEditingFilename) {
                        state.isEditingFilename = false;
                        state.editingFilename = '';
                        updatePreview();
                    } else {
                        modalOverlay.style.display = 'none';
                        closeDownloadDropdown();
                    }
                }
            });
        }

        // Initialize the app
        function init() {
            setupEventListeners();
            updateFileCount();
            updateQualityDisplay();
            updateSmartCompressionDisplay();
            updateFileSizeSliderMax();
            setupTabScrolling();
            updateButtonStates();
            
            // Initialize blur state
            updateBlurState();
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
